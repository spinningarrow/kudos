<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Kudos</title>

		<link rel="stylesheet" href="lib/normalize.css/normalize.css">
		<link rel="stylesheet" href="css/main.css">
		<link rel="stylesheet" href="css/graph.css">

		<script src="lib/jquery/dist/jquery.js"></script>
		<script src="lib/underscore/underscore.js"></script>
		<script src="lib/moment/moment.js"></script>
		<script src="lib/d3/d3.js"></script>
		<script src="dpd.js"></script>

		<script src="js/divisions.js"></script>
		<script src="js/colorbrewer.js"></script>

		<script src="lib/react/react.js"></script>
		<script src="lib/react/JSXTransformer.js"></script>
	</head>
	<body>
		<header>
			<h1>Kudos</h1>
			<div class="current-user-badge"></div>
		</header>
		<main class="main-content">
			<div class="content-login-form"></div>
			<div class="content-everything">
				<div id="divisions"></div>
				<section class="user-list-section"></section>
				<aside class="kudos-sidebar"></aside>
			</div>
		</main>

		<!-- React components -->
		<script type="text/jsx" src="react/LoginForm.jsx"></script>
		<script type="text/jsx" src="react/CurrentUserBox.jsx"></script>
		<script type="text/jsx" src="react/SignedInUser.jsx"></script>
		<script type="text/jsx" src="react/SignedOutUser.jsx"></script>
		<script type="text/jsx" src="react/Kudos.jsx"></script>
		<script type="text/jsx" src="react/UsersList.jsx"></script>

		<!-- Render stuff on the page -->
		<script type="text/jsx">
			var kudosData = [
				{ author: 'Peter Hunter', text: 'awesome is the new awesome' },
				{ author: 'Jordana Walker', text: 'nice is the new cool' }
			];

			dpd.users.get(function (users) {
				kudosData = users;
				console.log('users gotten');
				React.render(<KudosBox data={kudosData} />, document.querySelector('aside'));
			});

			dpd.on('kudos:created', function (kudo) {

				// Render user list again
				dpd.users.get(function (users) {
					// userList.setState({ data: users });

					kudosData = users;
					kudosBox.setProps({ data: kudosData });
				});

				// Transition node (tricky)
				var node = d3.select('.node.' + kudo.recipient);
				var originalRadius = node.attr('r');
				node.transition().duration(150).attr('r', +originalRadius + 100).transition().attr('r', originalRadius);
			});

			React.render(<LoginForm />, document.querySelector('.content-login-form'));
			var currentUserBox = React.render(<CurrentUserBox />, document.querySelector('.current-user-badge'));
			var kudosBox = React.render(<KudosBox data={kudosData} selectedUser={null} />, document.querySelector('aside'));
			// var userList = React.render(<UsersList />, document.querySelector('section'));

			function loginDone() {
				dpd.users.me(function (user) {
					currentUserBox.setState({ user: user.fullname });
					// $('main').hide();
					toggleSections('everything');
				});
			}

			function toggleSections(sectionToShow) {
				$('.content-login-form').hide();
				$('.content-everything').hide();

				if (sectionToShow === 'login') {
					$('.content-login-form').show();
				} else if (sectionToShow === 'everything') {
					$('.content-everything').show();
				}
			}

			toggleSections(); // hide everything
			// Hide login form if logged in
			// $('main').hide();
			dpd.users.me(function (user) {
				if (!user) {
					toggleSections('login');
				} else {
					toggleSections('everything');
				}
			});
		</script>
	</body>
</html>
