<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Kudos - Login</title>

		<link rel="stylesheet" href="lib/normalize.css/normalize.css">
		<link rel="stylesheet" href="css/main.css">

		<script src="lib/jquery/dist/jquery.js"></script>
		<script src="dpd.js"></script>
		<script src="js/app.js"></script>

		<script src="lib/react/react.js"></script>
		<script src="lib/react/JSXTransformer.js"></script>
	</head>
	<body>
		<header>
			<h1>Kudos</h1>
			<div class="current-user-badge"></div>
		</header>
		<main class="main-content"></main>

		<!-- Login form -->
		<script type="text/jsx">
			var LoginForm = React.createClass({

				handleSubmit: function (event) {
					event.preventDefault();

					var username = this.refs.username.getDOMNode().value.trim();
					var password = this.refs.password.getDOMNode().value.trim();

					if (!username || !password) {
						return;
					}

					// Log the user in
					dpd.users.login({
						username: username,
						password: password
					}, function (result, error) {
						if (!error) {
							loginDone();
							return;
						}

						console.log('Login error', error);
					});

					this.refs.username.getDOMNode().value = '';
					this.refs.password.getDOMNode().value = '';

					return;
				},

				render: function () {
					return (
						<form className="login-form" onSubmit={this.handleSubmit}>
							<input type="text" placeholder="Username" required ref="username" /><br />
							<input type="password" placeholder="Password" required ref="password" /><br />
							<button type="submit">Sign In</button>
						</form>
					);
				}
			});
		</script>

		<script type="text/jsx">
			var CurrentUserBox = React.createClass({
				getInitialState: function () {
					return {user: {}};
				},

				componentDidMount: function () {
					dpd.users.me(function (user) {
						this.setState({user: user ? user.fullname : ''});
					}.bind(this));
				},

				handleSignOutClick: function (event) {
					event.preventDefault();

					dpd.users.logout(function (result, error) {
						if (!error) {
							this.setState({ user: '' });
						}
					}.bind(this));
				},

				handleSignInClick: function (event) {
					event.preventDefault();

					// Focus the username field
					$('input[placeholder="Username"]').focus();
				},

				render: function () {
					return (
						<div>
							{ this.state.user ? <SignedInUser userFullName={this.state.user} handleSignOutClick={this.handleSignOutClick} /> :
								<SignedOutUser handleSignInClick={this.handleSignInClick} /> }
						</div>
					);
				}
			});
		</script>

		<script type="text/jsx">
			var SignedInUser = React.createClass({
				render: function () {
					return (
						<div className="signed-in-user">
							<span>{this.props.userFullName}</span>
							<a href="#" onClick={this.props.handleSignOutClick}>Sign out</a>
						</div>
					);
				}
			});

			var SignedOutUser = React.createClass({
				render: function () {
					return (
						<div><a href="#" onClick={this.props.handleSignInClick}>Sign in</a></div>
					);
				}
			});
		</script>

		<!-- Render stuff on the page -->
		<script type="text/jsx">
			React.render(<LoginForm />, document.querySelector('main'));
			var currentUserBox = React.render(<CurrentUserBox />, document.querySelector('.current-user-badge'));

			function loginDone() {
				dpd.users.me(function (user) {
					currentUserBox.setState({ user: user.fullname });
				});
			}
		</script>
	</body>
</html>
